# AI Code Review Workflow
# Uses anthropics/claude-code-action with CLIProxy (localhost:8317)

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

concurrency:
  group: >-
    ai-review-${{
      github.event_name == 'issue_comment' && (
        github.event.comment.user.type == 'Bot' ||
        !contains(github.event.comment.body, '/review')
      ) && format('skip-{0}', github.run_id) ||
      github.event.pull_request.number ||
      github.event.issue.number ||
      github.event.inputs.pr_number
    }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: [self-hosted, cliproxy]
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/review') &&
       github.event.comment.user.type != 'Bot')

    env:
      ANTHROPIC_BASE_URL: http://localhost:8317
      ANTHROPIC_AUTH_TOKEN: ccs-internal-managed
      ANTHROPIC_MODEL: gemini-claude-opus-4-5-thinking
      ANTHROPIC_DEFAULT_OPUS_MODEL: gemini-claude-opus-4-5-thinking
      ANTHROPIC_DEFAULT_SONNET_MODEL: gemini-claude-sonnet-4-5-thinking
      ANTHROPIC_DEFAULT_HAIKU_MODEL: gemini-claude-sonnet-4-5
      DISABLE_TELEMETRY: "1"

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CCS_REVIEWER_APP_ID }}
          private-key: ${{ secrets.CCS_REVIEWER_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ccs-internal-managed
          github_token: ${{ steps.app-token.outputs.token }}
          track_progress: ${{ github.event_name != 'workflow_dispatch' }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}

            Perform a comprehensive code review with the following focus areas:

            1. **Code Quality**
               - Clean code principles and best practices
               - Proper error handling and edge cases
               - Code readability and maintainability

            2. **Security**
               - Check for potential security vulnerabilities
               - Validate input sanitization
               - Review authentication/authorization logic

            3. **Performance**
               - Identify potential performance bottlenecks
               - Review database queries for efficiency
               - Check for memory leaks or resource issues

            4. **Testing**
               - Verify adequate test coverage
               - Review test quality and edge cases
               - Check for missing test scenarios

            5. **Documentation**
               - Ensure code is properly documented
               - Verify README updates for new features
               - Check API documentation accuracy

            Provide detailed feedback using inline comments for specific issues.
            Use top-level comments for general observations or praise.

          claude_args: |
            --allowedTools "Edit,Glob,Grep,LS,Read,Write,Bash(gh pr comment *),Bash(gh pr diff *),Bash(gh pr view *),Bash(gh issue view *),Bash(gh api *),Bash(git diff *),Bash(git log *),Bash(git status *),Bash(cat *),Bash(ls *),Bash(rm pr_review.md)"
